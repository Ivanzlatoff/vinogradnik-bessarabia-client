{"ast":null,"code":"import _regeneratorRuntime from\"D:/Work/vinogradnik/client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"D:/Work/vinogradnik/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import axios from'axios';import{TOKEN}from'./constants';import jwt_decode from\"jwt-decode\";export var BASE_URL='http://localhost:5000/api/';export var publicRequest=axios.create({baseURL:BASE_URL});export var userRequest=axios.create({baseURL:BASE_URL});export var updateRefreshToken=function updateRefreshToken(refreshToken,refreshTokenId){localStorage.setItem(TOKEN,JSON.stringify({refreshToken:refreshToken,refreshTokenId:refreshTokenId}));};export var getRefreshToken=function getRefreshToken(){return JSON.parse(localStorage.getItem(TOKEN)||'{}');};export var existRefreshToken=function existRefreshToken(){return!!getRefreshToken().refreshToken;};export var clearRefreshToken=function clearRefreshToken(){return localStorage.removeItem(TOKEN);};userRequest.interceptors.request.use(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(config){var existingAccessToken,_config$headers$token,accessToken,currentDate,decodedToken,_getRefreshToken,refreshToken,refreshTokenId,res;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:existingAccessToken=!!config.headers.token;if(existingAccessToken){accessToken=(_config$headers$token=config.headers.token)===null||_config$headers$token===void 0?void 0:_config$headers$token.substring(7);currentDate=new Date();decodedToken=accessToken&&jwt_decode(accessToken);existingAccessToken=decodedToken&&decodedToken.exp*1000<currentDate.getTime();}if(existingAccessToken){_context.next=15;break;}_getRefreshToken=getRefreshToken(),refreshToken=_getRefreshToken.refreshToken,refreshTokenId=_getRefreshToken.refreshTokenId;_context.prev=4;_context.next=7;return publicRequest.put(\"/auth/refresh_token\",{refreshToken:refreshToken,refreshTokenId:refreshTokenId});case 7:res=_context.sent;updateRefreshToken(res.data.refreshToken,refreshTokenId);config.headers[\"token\"]=\"Bearer \"+res.data.newAccessToken;_context.next=15;break;case 12:_context.prev=12;_context.t0=_context[\"catch\"](4);console.error(_context.t0);case 15:return _context.abrupt(\"return\",config);case 16:case\"end\":return _context.stop();}},_callee,null,[[4,12]]);}));return function(_x){return _ref.apply(this,arguments);};}(),function(error){return Promise.reject(error);});","map":{"version":3,"names":["axios","TOKEN","jwt_decode","BASE_URL","publicRequest","create","baseURL","userRequest","updateRefreshToken","refreshToken","refreshTokenId","localStorage","setItem","JSON","stringify","getRefreshToken","parse","getItem","existRefreshToken","clearRefreshToken","removeItem","interceptors","request","use","config","existingAccessToken","headers","token","accessToken","substring","currentDate","Date","decodedToken","exp","getTime","put","res","data","newAccessToken","console","error","Promise","reject"],"sources":["D:/Work/vinogradnik/client/src/requestMethods.js"],"sourcesContent":["import axios from 'axios';\r\nimport { TOKEN } from './constants';\r\nimport jwt_decode from \"jwt-decode\";\r\n\r\nexport const BASE_URL = 'http://localhost:5000/api/';\r\n\r\nexport const publicRequest = axios.create({\r\n    baseURL: BASE_URL\r\n});\r\n\r\nexport const userRequest = axios.create({\r\n    baseURL: BASE_URL,\r\n});\r\n\r\nexport const updateRefreshToken = (refreshToken, refreshTokenId) => {\r\n    localStorage.setItem(TOKEN, JSON.stringify({\r\n        refreshToken,\r\n        refreshTokenId\r\n    }))\r\n};\r\n\r\nexport const getRefreshToken = () => JSON.parse(localStorage.getItem(TOKEN) || '{}');\r\n\r\nexport const existRefreshToken = () => !!getRefreshToken().refreshToken;\r\n\r\nexport const clearRefreshToken = () => localStorage.removeItem(TOKEN);\r\n\r\nuserRequest.interceptors.request.use(async (config) => {\r\n    let existingAccessToken = !!config.headers.token;\r\n    if (existingAccessToken) {\r\n        const accessToken = config.headers.token?.substring(7);\r\n        let currentDate = new Date();\r\n        const decodedToken = accessToken && jwt_decode(accessToken);\r\n        existingAccessToken = decodedToken && decodedToken.exp * 1000 < currentDate.getTime();\r\n    }\r\n    if (!existingAccessToken) {\r\n        const { refreshToken, refreshTokenId } = getRefreshToken();\r\n        try {\r\n            const res = await publicRequest.put(\"/auth/refresh_token\", { refreshToken, refreshTokenId });\r\n            updateRefreshToken(res.data.refreshToken, refreshTokenId);\r\n            config.headers[\"token\"] = \"Bearer \" + res.data.newAccessToken;\r\n        } catch (err) {\r\n            console.error(err)\r\n        }\r\n    }\r\n    return config;\r\n}, (error) => {\r\n    return Promise.reject(error)\r\n});\r\n"],"mappings":"gPAAA,MAAOA,MAAK,KAAM,OAAO,CACzB,OAASC,KAAK,KAAQ,aAAa,CACnC,MAAOC,WAAU,KAAM,YAAY,CAEnC,MAAO,IAAMC,SAAQ,CAAG,4BAA4B,CAEpD,MAAO,IAAMC,cAAa,CAAGJ,KAAK,CAACK,MAAM,CAAC,CACtCC,OAAO,CAAEH,QACb,CAAC,CAAC,CAEF,MAAO,IAAMI,YAAW,CAAGP,KAAK,CAACK,MAAM,CAAC,CACpCC,OAAO,CAAEH,QACb,CAAC,CAAC,CAEF,MAAO,IAAMK,mBAAkB,CAAG,QAArBA,mBAAkB,CAAIC,YAAY,CAAEC,cAAc,CAAK,CAChEC,YAAY,CAACC,OAAO,CAACX,KAAK,CAAEY,IAAI,CAACC,SAAS,CAAC,CACvCL,YAAY,CAAZA,YAAY,CACZC,cAAc,CAAdA,cACJ,CAAC,CAAC,CAAC,CACP,CAAC,CAED,MAAO,IAAMK,gBAAe,CAAG,QAAlBA,gBAAe,SAASF,KAAI,CAACG,KAAK,CAACL,YAAY,CAACM,OAAO,CAAChB,KAAK,CAAC,EAAI,IAAI,CAAC,GAEpF,MAAO,IAAMiB,kBAAiB,CAAG,QAApBA,kBAAiB,SAAS,CAAC,CAACH,eAAe,EAAE,CAACN,YAAY,GAEvE,MAAO,IAAMU,kBAAiB,CAAG,QAApBA,kBAAiB,SAASR,aAAY,CAACS,UAAU,CAACnB,KAAK,CAAC,GAErEM,WAAW,CAACc,YAAY,CAACC,OAAO,CAACC,GAAG,4FAAC,iBAAOC,MAAM,uPAC1CC,mBAAmB,CAAG,CAAC,CAACD,MAAM,CAACE,OAAO,CAACC,KAAK,CAChD,GAAIF,mBAAmB,CAAE,CACfG,WAAW,wBAAGJ,MAAM,CAACE,OAAO,CAACC,KAAK,gDAApB,sBAAsBE,SAAS,CAAC,CAAC,CAAC,CAClDC,WAAW,CAAG,GAAIC,KAAI,EAAE,CACtBC,YAAY,CAAGJ,WAAW,EAAI1B,UAAU,CAAC0B,WAAW,CAAC,CAC3DH,mBAAmB,CAAGO,YAAY,EAAIA,YAAY,CAACC,GAAG,CAAG,IAAI,CAAGH,WAAW,CAACI,OAAO,EAAE,CACzF,CAAC,GACIT,mBAAmB,2CACqBV,eAAe,EAAE,CAAlDN,YAAY,kBAAZA,YAAY,CAAEC,cAAc,kBAAdA,cAAc,uCAEdN,cAAa,CAAC+B,GAAG,CAAC,qBAAqB,CAAE,CAAE1B,YAAY,CAAZA,YAAY,CAAEC,cAAc,CAAdA,cAAe,CAAC,CAAC,QAAtF0B,GAAG,eACT5B,kBAAkB,CAAC4B,GAAG,CAACC,IAAI,CAAC5B,YAAY,CAAEC,cAAc,CAAC,CACzDc,MAAM,CAACE,OAAO,CAAC,OAAO,CAAC,CAAG,SAAS,CAAGU,GAAG,CAACC,IAAI,CAACC,cAAc,CAAC,iFAE9DC,OAAO,CAACC,KAAK,aAAK,yCAGnBhB,MAAM,sEAChB,+DAAE,SAACgB,KAAK,CAAK,CACV,MAAOC,QAAO,CAACC,MAAM,CAACF,KAAK,CAAC,CAChC,CAAC,CAAC"},"metadata":{},"sourceType":"module","externalDependencies":[]}